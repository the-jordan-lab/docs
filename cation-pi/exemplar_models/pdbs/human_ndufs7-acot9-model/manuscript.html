<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Manuscript Figure Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .manuscript-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .figure-panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            background-color: white;
        }
        .figure-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .figure-cell {
            border: 1px dashed #ccc;
            padding: 5px;
            position: relative;
        }
        .viewer-small {
            width: 300px;
            height: 300px;
            position: relative;
        }
        .viewer-medium {
            width: 450px;
            height: 450px;
            position: relative;
        }
        .viewer-large {
            width: 600px;
            height: 500px;
            position: relative;
        }
        h2, h3 {
            margin-top: 20px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .inset-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .inset-controls label {
            margin-right: 5px;
        }
        .panel-label {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            font-weight: bold;
            border-bottom-right-radius: 5px;
            z-index: 100;
        }
        .figure-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .label-settings {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        .color-picker {
            display: inline-block;
            width: 30px;
            height: 20px;
            border: 1px solid #ccc;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <h1>Manuscript Figure Builder</h1>
    <p>Create optimized views for manuscript figures. Group structures, create insets, and export ready-to-use figures.</p>
    <p><a href="index.html">‚Üê Back to Main Index</a></p>
    
    <div class="controls">
        <h3>Figure Settings</h3>
        <div>
            <button id="add-row-btn">Add Row</button>
            <button id="add-2col-btn">Add 2-Column Row</button>
            <button id="add-3col-btn">Add 3-Column Row</button>
            <button id="capture-figure-btn">Export Figure as PNG</button>
        </div>
        
        <div class="label-settings">
            <h4>Global Label Settings</h4>
            <div>
                <label>Font Size:</label>
                <select id="global-font-size">
                    <option value="20">Small (20px)</option>
                    <option value="28" selected>Medium (28px)</option>
                    <option value="36">Large (36px)</option>
                </select>
                
                <label style="margin-left:15px">Font Weight:</label>
                <select id="global-font-weight">
                    <option value="normal">Normal</option>
                    <option value="bold" selected>Bold</option>
                </select>
                
                <label style="margin-left:15px">Background:</label>
                <select id="global-background">
                    <option value="false">None</option>
                    <option value="true" selected>Show</option>
                </select>
            </div>
            <div style="margin-top:10px">
                <label>Chain A Label Color:</label>
                <input type="color" id="chain-a-color" value="#2c4e6f" class="color-picker">
                
                <label style="margin-left:15px">Chain B Label Color:</label>
                <input type="color" id="chain-b-color" value="#8B4513" class="color-picker">
                
                <label style="margin-left:15px">Stroke Width:</label>
                <select id="global-stroke-width">
                    <option value="2">Thin (2px)</option>
                    <option value="3" selected>Medium (3px)</option>
                    <option value="4">Thick (4px)</option>
                </select>
            </div>
        </div>
    </div>
    
    <div id="manuscript-container" class="manuscript-container">
        <!-- Rows and viewers will be added here -->
    </div>
</body>
</html>
<script>
// Available protein structures
const availableProteins = [
    { id: 'ACOT9', name: 'ACOT9 (1 structures)', url: 'histidine_acot9_20250415_014056.html' },
];


// Global settings that will be applied to new viewers
const globalSettings = {
    fontSize: 28,
    fontWeight: 'bold',
    showBackground: true,
    chainAColor: '#2c4e6f',
    chainBColor: '#8B4513',
    strokeWidth: 3
};

// Load and display a protein structure with specified options
function loadStructure(proteinId, viewerId, viewType) {
    if (!proteinId) return;

    // Find the protein in our available list
    const protein = availableProteins.find(p => p.id === proteinId);
    if (!protein) return;

    // Open the protein's HTML file in a hidden iframe to extract the structure data
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = protein.url;
    document.body.appendChild(iframe);

    // Wait for iframe to load
    iframe.onload = function() {
        try {
            // Find a 3DMol viewer in the iframe that matches our viewType
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // Create a new viewer in our current document
            let viewer = $3Dmol.createViewer($(`#${viewerId}`), {
                backgroundColor: "white"
            });
            
            // Based on viewType, try to extract either ribbon or labeled view HTML
            let scriptContent;
            let modelData;
            
            // Find all scripts in the iframe
            const scripts = iframeDoc.querySelectorAll('script');
            for (let script of scripts) {
                // Look for scripts that contain our viewer type
                if ((viewType === 'ribbon' && script.textContent.includes('cartoon')) ||
                    (viewType === 'label' && script.textContent.includes('addLabel'))) {
                    
                    scriptContent = script.textContent;
                    break;
                }
            }
            
            // If we found a script with the right content
            if (scriptContent) {
                // Extract the PDB data from the script
                const pdbMatch = scriptContent.match(/let pdbData = `([^`]+)`/);
                if (pdbMatch && pdbMatch[1]) {
                    modelData = pdbMatch[1];
                    
                    // Configure the viewer with the extracted data
                    viewer.addModel(modelData, "pdb");
                    
                    // Set basic view style
                    viewer.setViewStyle({
                        style: 'outline',
                        color: 'gray',
                        width: 0.01
                    });
                    
                    // Add surfaces
                    viewer.addSurface($3Dmol.SAS, {opacity: 0.6, color: '#4e79a7'}, {chain: 'A'});
                    viewer.addSurface($3Dmol.SAS, {opacity: 0.6, color: '#f2be2b'}, {chain: 'B'});
                    
                    if (viewType === 'ribbon') {
                        // Add ribbons
                        viewer.setStyle({chain: 'A'}, {cartoon: {color: '#4e79a7', opacity: 1.0}});
                        viewer.setStyle({chain: 'B'}, {cartoon: {color: '#f2be2b', opacity: 1.0}});
                    } else {
                        // Hide cartoon for label view
                        viewer.setStyle({model: -1}, {cartoon: {hidden: true}});
                        
                        // Add sticks and labels by extracting this data from the script
                        const stickMatch = scriptContent.match(/viewer.setStyle\(\{\s*chain:.*?\},\s*\{\s*stick:.*?\}\)/g);
                        if (stickMatch) {
                            for (let stick of stickMatch) {
                                eval('viewer.' + stick.substring(7));
                            }
                        }
                        
                        const labelMatch = scriptContent.match(/viewer.addLabel\(.*?\)/g);
                        if (labelMatch) {
                            for (let label of labelMatch) {
                                // Apply global label settings
                                let modifiedLabel = label.replace(/fontSize: \d+/, `fontSize: ${globalSettings.fontSize}`);
                                modifiedLabel = modifiedLabel.replace(/fontWeight: ['"].*?['"]/, `fontWeight: '${globalSettings.fontWeight}'`);
                                modifiedLabel = modifiedLabel.replace(/strokeWidth: \d+/, `strokeWidth: ${globalSettings.strokeWidth}`);
                                
                                // Font colors
                                if (label.includes("chain: 'A'")) {
                                    modifiedLabel = modifiedLabel.replace(/fontColor: ['"].*?['"]/, `fontColor: '${globalSettings.chainAColor}'`);
                                } else {
                                    modifiedLabel = modifiedLabel.replace(/fontColor: ['"].*?['"]/, `fontColor: '${globalSettings.chainBColor}'`);
                                }
                                
                                // Background
                                if (globalSettings.showBackground) {
                                    modifiedLabel = modifiedLabel.replace(/showBackground: \w+/, `showBackground: true`);
                                } else {
                                    modifiedLabel = modifiedLabel.replace(/showBackground: \w+/, `showBackground: false`);
                                }
                                
                                eval('viewer.' + modifiedLabel.substring(7));
                            }
                        }
                    }
                    
                    viewer.zoomTo();
                    viewer.render();
                }
            }
        } catch (e) {
            console.error("Error loading structure:", e);
        } finally {
            // Clean up
            document.body.removeChild(iframe);
        }
    };
}

// Add a new row to the figure
function addRow(numCols = 1) {
    const container = document.getElementById('manuscript-container');
    const rowIndex = container.children.length + 1;
    
    const row = document.createElement('div');
    row.className = 'figure-row';
    row.id = `row-${rowIndex}`;
    
    for (let i = 1; i <= numCols; i++) {
        const cell = document.createElement('div');
        cell.className = 'figure-cell';
        
        const cellControls = document.createElement('div');
        cellControls.innerHTML = `
            <div style="margin-bottom:10px">
                <select class="protein-select" data-row="${rowIndex}" data-col="${i}">
                    <option value="">Select protein...</option>
                    ${availableProteins.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                </select>
                
                <select class="view-type" data-row="${rowIndex}" data-col="${i}">
                    <option value="ribbon">Ribbon view</option>
                    <option value="label">Labeled view</option>
                </select>
                
                <select class="viewer-size" data-row="${rowIndex}" data-col="${i}">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                </select>
            </div>
            <div class="viewer-container">
                <div class="panel-label">${String.fromCharCode(64 + rowIndex)}${i}</div>
                <div id="viewer-${rowIndex}-${i}" class="viewer-medium"></div>
            </div>
        `;
        
        cell.appendChild(cellControls);
        row.appendChild(cell);
    }
    
    container.appendChild(row);
    
    // Add event listeners to the new selects
    row.querySelectorAll('.protein-select').forEach(select => {
        select.addEventListener('change', function() {
            const row = this.dataset.row;
            const col = this.dataset.col;
            const viewType = document.querySelector(`.view-type[data-row="${row}"][data-col="${col}"]`).value;
            const viewerId = `viewer-${row}-${col}`;
            loadStructure(this.value, viewerId, viewType);
        });
    });
    
    row.querySelectorAll('.view-type').forEach(select => {
        select.addEventListener('change', function() {
            const row = this.dataset.row;
            const col = this.dataset.col;
            const proteinId = document.querySelector(`.protein-select[data-row="${row}"][data-col="${col}"]`).value;
            const viewerId = `viewer-${row}-${col}`;
            if (proteinId) {
                loadStructure(proteinId, viewerId, this.value);
            }
        });
    });
    
    row.querySelectorAll('.viewer-size').forEach(select => {
        select.addEventListener('change', function() {
            const row = this.dataset.row;
            const col = this.dataset.col;
            const viewerId = document.getElementById(`viewer-${row}-${col}`);
            
            // Remove existing size classes
            viewerId.classList.remove('viewer-small', 'viewer-medium', 'viewer-large');
            
            // Add the new size class
            viewerId.classList.add(`viewer-${this.value}`);
            
            // Reload the viewer to update the size
            setTimeout(() => {
                const proteinId = document.querySelector(`.protein-select[data-row="${row}"][data-col="${col}"]`).value;
                if (proteinId) {
                    const viewType = document.querySelector(`.view-type[data-row="${row}"][data-col="${col}"]`).value;
                    loadStructure(proteinId, `viewer-${row}-${col}`, viewType);
                }
            }, 100);
        });
    });
}

// Capture the figure as an image
function captureFigure() {
    html2canvas(document.getElementById('manuscript-container')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'manuscript-figure.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

// Event listeners for the control buttons
document.getElementById('add-row-btn').addEventListener('click', () => addRow(1));
document.getElementById('add-2col-btn').addEventListener('click', () => addRow(2));
document.getElementById('add-3col-btn').addEventListener('click', () => addRow(3));
document.getElementById('capture-figure-btn').addEventListener('click', captureFigure);

// Update global settings when controls change
document.getElementById('global-font-size').addEventListener('change', function() {
    globalSettings.fontSize = parseInt(this.value);
});

document.getElementById('global-font-weight').addEventListener('change', function() {
    globalSettings.fontWeight = this.value;
});

document.getElementById('global-background').addEventListener('change', function() {
    globalSettings.showBackground = this.value === 'true';
});

document.getElementById('chain-a-color').addEventListener('change', function() {
    globalSettings.chainAColor = this.value;
});

document.getElementById('chain-b-color').addEventListener('change', function() {
    globalSettings.chainBColor = this.value;
});

document.getElementById('global-stroke-width').addEventListener('change', function() {
    globalSettings.strokeWidth = parseInt(this.value);
});

// Add an initial row to get started
addRow(2);
</script>
</body>
</html>
